apiVersion: batch/v1
kind: Job
metadata:
  name: postgresql-init-argo
  namespace: tenant-assetaip-dev
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: postgresql-init-argo
          image: postgres:17-trixie
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "-c"]
          args:
            - |
              export PGPASSWORD='${postgres_password}'
              export PGHOST='${db_host}'
              export PGPORT='${db_port}'

              DB_NAME='${argo_database}'
              DB_USER='${argo_username}'
              DB_PASS='${argo_password}'

              # Check if DB exists
              if ! psql -U postgres -tAc "SELECT 1 FROM pg_database WHERE datname='$DB_NAME'" | grep -q 1; then
                echo "Creating Argo database..."
                psql -U postgres -c "CREATE ROLE $DB_USER WITH LOGIN PASSWORD '$DB_PASS';"
                psql -U postgres -c "CREATE DATABASE $DB_NAME WITH OWNER $DB_USER;"
              else
                echo "Database $DB_NAME already exists, skipping."
              fi
      nodeSelector:
        "cosmotech.com/tier": services
      tolerations:
        - key: "vendor"
          operator: "Equal"
          value: "cosmotech"
          effect: "NoSchedule"
      dnsPolicy: ClusterFirst
