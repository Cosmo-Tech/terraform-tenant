apiVersion: batch/v1
kind: Job
metadata:
  name: postgresql-init-seaweedfs
  namespace: tenant-assetaip-dev
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: postgresql-init-seaweedfs
          image: postgres:17-trixie
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "-c"]
          args:
            - |
              export PGPASSWORD='${postgres_password}'
              export PGHOST='${db_host}'
              export PGPORT='${db_port}'

              DB_NAME='${seaweedfs_database}'
              DB_USER='${seaweedfs_username}'
              DB_PASS='${seaweedfs_password}'

              if ! psql -U postgres -tAc "SELECT 1 FROM pg_database WHERE datname='$DB_NAME'" | grep -q 1; then
                echo "Creating SeaweedFS database..."
                psql -U postgres -c "CREATE ROLE $DB_USER WITH LOGIN PASSWORD '$DB_PASS';"
                psql -U postgres -c "CREATE DATABASE $DB_NAME WITH OWNER $DB_USER;"

                export PGPASSWORD="$DB_PASS"
                psql -U $DB_USER -d $DB_NAME -c "
                  CREATE TABLE IF NOT EXISTS filemeta (
                    dirhash     BIGINT,
                    name        VARCHAR(65535),
                    directory   VARCHAR(65535),
                    meta        bytea,
                    PRIMARY KEY (dirhash, name)
                  );
                "
              else
                echo "Database $DB_NAME already exists, skipping."
              fi
      nodeSelector:
        "cosmotech.com/tier": services
      tolerations:
        - key: "vendor"
          operator: "Equal"
          value: "cosmotech"
          effect: "NoSchedule"
      dnsPolicy: ClusterFirst
